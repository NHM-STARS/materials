---
title: "dealing-with-data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Dealing with data in R
There is a presentation which goes with this handout, use it to add notes if you need to.

Before we start, remember we need to do a couple of things

### 1. Set the working directory
See the introduction handout if you can't remember how.

Check it worked using:
```{r}
list.files()
```

### 2. Load the packages needed
We already downloaded these and don't need to do that again. 
```{r}
library(dplyr)
library(tidyr)
```
### 3. Import the data
compensation <- read.csv("compensation.csv")




## Checking the data
The next, and very important step, of any data analysis is to check that R read in your dataset correctly.

Base R has a number of ways of doing this. Try out the following and add notes about what each of them does.

```{r}
dim(compensation) 
```

```{r}
names(compensation)
```

```{r}
head(compensation)
```

```{r}
str(compensation)
```

```{r}
tail(compensation)
```

# Data manipulation with dplyr
`dplyr` is an excellent, and fairly new, package for manipulating dataframes (the core data storage format in R).
Each `dplyr` function does one thing, and does it very quickly and efficiently. With each `dplyr` function the first argument is always the name of the dataframe (here `compensation`).

## Looking at data with dplyr
We can also do this using `dplyr`. Make notes on what these do

```{r}
tbl_df(compensation)
```

```{r}
glimpse(compensation)
```


## Subsetting with dplyr


# select is all about columns
select(compensation, Root, Fruit)
select(compensation, -Grazing)

# slice to get rows 
slice(compensation, 2)
slice(compensation, 2:5)
slice(compensation, c(2,5))

# piping
magicNumber <- compensation %>%
  select(Fruit) %>%
    slice(8)
magicNumber

# filter
fruit80 <- filter(compensation, Fruit > 80)
select(fruit80, Root)

fruit80_RootVals <- compensation %>%
  filter(Fruit>80) %>%
    select(Root)

filter(compensation, Grazing != "Ungrazed")

# mutate adds columns
compensation <- mutate(compensation, RFratio = Root/Fruit)
head(compensation)

# sorting using arrange
arrange(compensation, Grazing, Fruit)
arrange(compensation, Grazing, desc(Fruit)) # descending order

# summarisation
compensation %>% 
  summarise(
    meanFruit = mean(Fruit),
    sdFruit = sd(Fruit))

# grouping via piping
summaryFruit <- compensation %>% 
  group_by(Grazing) %>%
  summarise(
    meanFruit = mean(Fruit),
    sdFruit = sd(Fruit))

# not piping
summarise(
  group_by(compensation, Grazing),
  meanFruit = mean(Fruit),
  sdFruit = sd(Fruit)) 

# string together several functions
# Ratio column in raw data is lost
compensation %>%
  mutate(FRrat=Fruit/Root) %>%
    group_by(Grazing) %>%
      summarise(
        meanFRrat = mean(FRrat))

# no pipe.  Ratio column retained
compensation <- mutate(compensation, FRrat = Fruit/Root)
compensation %>%
  group_by(Grazing) %>%
    summarise(
      meanFRrat = mean(FRrat),
      sdFRrat = sd(FRrat))

# Tidy R...

#-------------------------
Using tidyr and lubridate
#-------------------------

# Clear R's brain
rm(list=ls())

# Load libraries
library(dplyr)
library(tidyr)
library(lubridate)

# ------------------------
# Tidying data with tidyr
# ------------------------
	
# Read in the three datasets we need
# Note that your code will be different depending on where you saved the datasets
museum1 <- read.csv("~/Dropbox/R4All_Share/modules/0 - datasets/museum1.csv")
museum2 <- read.csv("~/Dropbox/R4All_Share/modules/0 - datasets/museum2.csv")
museum3 <- read.csv("~/Dropbox/R4All_Share/modules/0 - datasets/museum3.csv")

# Look at the data
tbl_df(museum1)
tbl_df(museum2)
tbl_df(museum3)

# Dealing with multiple columns for one variable (gather)
gather(museum1, Location, Number, MammalTower:Warehouse)

# Problems with NAs
gather(museum2, Location, Number, MammalTower:Warehouse)
gather(museum2, Location, Number, MammalTower:Warehouse, na.rm = TRUE)

# To order by Species and remove extra Number column
tidy2<- museum2 %>%
  gather(Location, Number, MammalTower:Warehouse, na.rm = TRUE) %>%
  arrange(desc(Species)) %>%
  select( -Number)

# Splitting one column into multiple columns (spread)  
spread(museum3, Type, Length)

# Dealing with multiple variables in one column (separate)
separate(museum3, Status, c("Sex", "Age")," ")

# Combining multiple columns into one column (unite)
unite(museum3, Spec, 
  c(SpecimenID, Species), sep = "_")

#--------------------------------------
# Fixing dates and times with lubridate
#--------------------------------------

tbl_df(museum3)
arrange(museum3, CollectionDate)
#What do you notice?

# Create a new variable with correctly parsed dates
newmus <- mutate(museum3, DateCollected = dmy(CollectionDate))
# See how this changes the dates
tbl_df(newmus)
arrange(newmus, DateCollected)

# Final tidying exercise
# Creates a new column called DateCollected with correct parsing of dates
# Splits Status column in Sex and Age
# Arrange by Species 
# Remove defunct/useless column CollectionDate
tidymuseum <- museum3 %>%
  mutate(DateCollected = dmy(CollectionDate)) %>%
  separate(Status, c("Sex","Age")," ") %>%
  arrange(Species) %>%
  select(-CollectionDate)
